<html>

<head>
	<meta charset="utf-8"/>
	<title>trigger</title>

	<style type="text/css">
	</style>

</head>

<body>
	<h1>trigger</h1>

	<script type="module">
		import {
			text_to_note,
			note_to_text,
			normalize_javascript_midi_msg,
		} from './music.js';
		import {
			SubscriptionSocketReconnect,
		} from './websocket.js';

		// Constants
		const QUERY_STRING_KEY_path_eventmap = 'path_eventmap';

		const urlParams = new URLSearchParams(window.location.search);



		// SubscriptionSocketReconnect -----------------------------------------

		const socket = new SubscriptionSocketReconnect();
		socket.onConnected = () => {console.log('onConnected');};
    	socket.onDisconnected = () => {console.log('onDisconnected');}


		// System Midi Input ---------------------------------------------------

		function onMidiMessage(midiDevice, msg) {
			const midiMsg = normalize_javascript_midi_msg(msg);
			console.debug(midiDevice.name, midiMsg);
			// TODO: use midi input
		};

		function bindMidiDevices(midiAccess) {
			for (let midiDevice of midiAccess.inputs.values()) {
				midiDevice.onmidimessage = (msg) => onMidiMessage(midiDevice, msg);
			}
		};
		function initMidi(bindMidiDevices) {
			if (window.navigator.requestMIDIAccess) {
				window.navigator.requestMIDIAccess({sysex: false}).then(bindMidiDevices, function() {console.warn('MIDI Access Failed');});
			} else {console.warn("No browser MIDI support");}
		};
		initMidi(bindMidiDevices);

		// Eventmap Management -------------------------------------------------

		const PATH_EVENTMAP = urlParams.get(QUERY_STRING_KEY_path_eventmap) || '/eventmap/';

		if (!urlParams.has('eventmap')) {
			function render_eventmaps(data) {
				// data is JSON_INDEX from nginx file listing
				const eventmaps = data.map(i => i.name).filter(i => i.indexOf('.json') >= 0);
				for (let eventmap of eventmaps) {
					const _urlParams = new URLSearchParams(urlParams);
					_urlParams.append('eventmap', eventmap);
					const html = `<li><a href="${window.location.pathname}?${_urlParams.toString()}">${eventmap}</a></li>`;
					console.log(html);
				}
			}
			console.log(`Loading eventmaps from ${PATH_EVENTMAP}. You can optionally override this path with querystring param ${QUERY_STRING_KEY_path_eventmap}`);
			fetch(PATH_EVENTMAP)
				.then(r => r.json())
				.then(data => render_eventmaps(data))
				.catch(e => console.error("Failed to list eventmap", e))
			;
		}

	</script>
</body>
